# 爬虫调试指南

如果爬虫返回的结果不正确或为空，按照以下步骤调试。

## 问题1：AutoTrader返回固定结果或N/A

### 原因
- HTML选择器不匹配网站的实际结构
- 网站使用JavaScript动态加载内容

### 解决方案

#### 步骤1：检查Render的日志

1. 打开 https://render.com
2. 进入你的 `car-scraper` 应用
3. 点击 "Logs" 标签
4. 搜索 "AutoTrader" 或 "Scraping"
5. 查看日志中的信息

日志应该显示：
```
Scraping AutoTrader: https://www.autotrader.ca/cars/?keyword=Honda+Civic&prv=canada
Found X car links on AutoTrader
Successfully scraped Y listings from AutoTrader
```

#### 步骤2：测试API端点

访问你的应用，打开浏览器开发者工具（F12），在Console中运行：

```javascript
fetch('/api/search', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({car_model: 'Honda Civic', location: 'canada'})
})
.then(r => r.json())
.then(d => console.log(JSON.stringify(d, null, 2)))
```

查看返回的数据。

#### 步骤3：检查返回的数据

如果返回的数据中：
- `total_listings` 为 0 → 爬虫没有找到任何结果
- `listings` 中的 `price` 都是 "N/A" → 选择器不匹配
- `listings` 中的 `title` 都相同 → 数据提取有问题

### 修复步骤

如果爬虫不工作，我会需要：

1. **AutoTrader网站的HTML结构**
   - 打开 https://www.autotrader.ca/cars/?keyword=Honda+Civic
   - 按F12打开开发者工具
   - 右键点击一个车的标题
   - 选择 "Inspect" 或 "Inspect Element"
   - 告诉我你看到的HTML标签和class名

2. **具体的错误信息**
   - 搜索一个车型
   - 告诉我返回了什么结果
   - 告诉我期望的结果是什么

## 问题2：Kijiji没有返回结果

### 原因
- Kijiji的URL格式可能不正确
- 网站结构改变了

### 解决方案

1. 手动访问 https://www.kijiji.ca/b-cars/canada/Honda%20Civic/k0c174l0
2. 检查是否有搜索结果
3. 如果有结果，告诉我页面的HTML结构

## 问题3：Facebook Marketplace没有返回结果

### 原因
- Facebook Marketplace需要认证
- 需要JavaScript渲染

### 说明
目前的爬虫对Facebook Marketplace的支持有限。如果你需要这个功能，我们可以：
1. 使用专门的Facebook API（需要应用认证）
2. 使用Selenium浏览器自动化（但会更慢）

## 调试技巧

### 1. 启用详细日志

如果你想看到更多的调试信息，可以修改 `app.py` 中的日志级别：

```python
logging.basicConfig(level=logging.DEBUG)  # 改为 DEBUG 而不是 INFO
```

### 2. 本地测试

在你的电脑上运行应用：

```bash
cd /path/to/car_scraper
python app.py
```

然后在浏览器中打开 http://localhost:5000，测试搜索功能。

### 3. 检查网络请求

在浏览器开发者工具中：
1. 打开 "Network" 标签
2. 搜索一个车型
3. 查看 `/api/search` 请求
4. 检查 "Response" 标签中的返回数据

## 常见问题

### Q: 为什么AutoTrader总是返回相同的结果？

A: 这通常是因为HTML选择器不匹配。爬虫找不到真实的数据，所以返回了默认值。

**解决方案：**
1. 检查Render的日志，看 "Found X car links" 是多少
2. 如果是0，说明选择器完全不工作
3. 如果是正数，说明找到了链接，但数据提取有问题

### Q: 搜索很慢

A: 爬虫需要时间从网站下载和解析HTML。这是正常的。

**优化方案：**
- 增加超时时间
- 使用缓存（保存最近的搜索结果）
- 使用API而不是网页爬虫（如果可用）

### Q: 如何知道爬虫是否在工作？

A: 查看Render的日志。应该看到：
```
Scraping Kijiji: ...
Found X items on Kijiji
Successfully scraped Y listings from Kijiji
Scraping AutoTrader: ...
Found X car links on AutoTrader
Successfully scraped Y listings from AutoTrader
```

## 需要帮助？

如果按照上面的步骤做了还是不工作，请提供：

1. **搜索的车型**（例如"Honda Civic"）
2. **Render的日志**（完整的日志输出）
3. **浏览器控制台的错误**（如果有）
4. **期望的结果**（你在网站上看到了什么）

这样我能更好地帮你调试。

---

## 爬虫工作流程

```
用户搜索 "Honda Civic"
    ↓
Flask应用接收请求
    ↓
调用 scrape_kijiji()
    ├─ 发送HTTP请求到Kijiji
    ├─ 解析HTML
    ├─ 提取标题、价格、公里数等
    └─ 返回结果列表
    ↓
调用 scrape_autotrader()
    ├─ 发送HTTP请求到AutoTrader
    ├─ 解析HTML
    ├─ 提取标题、价格、公里数等
    └─ 返回结果列表
    ↓
合并所有结果
    ↓
返回JSON给前端
    ↓
前端显示结果
```

如果任何一步失败，整个流程都会受影响。

---

祝调试成功！

